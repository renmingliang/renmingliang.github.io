{"version":3,"sources":["webpack:///src/views/onload.vue","webpack:///./src/views/onload.vue?2f5e","webpack:///./src/views/onload.vue","webpack:///./node_modules/babel-runtime/core-js/get-iterator.js","webpack:///./node_modules/core-js/library/fn/get-iterator.js","webpack:///./node_modules/core-js/library/modules/core.get-iterator.js"],"names":["views_onload","ready","computed","extends_default","Object","vuex_esm","show","_this","this","DBname","length","initDatabase","preLoadImg","validateData","name","result","res","type","errorCode","storeNum","event","storeName","_iteratorNormalCompletion","item","_step","value","_this2","_step2","Image","HeadImg","catchImg","_this3","endTime","stopTimer","selectortype_template_index_0_src_views_onload","render","_vm","_h","$createElement","_c","_self","staticClass","attrs","active","isActive","finish-status","title","description","getNum","_v","step","status","stop","class","classStop","_s","tips","_e","staticRenderFns","Component","__webpack_require__","normalizeComponent","ssrContext","__webpack_exports__","module","exports","default","__esModule","anObject","get","getIterator","it","iterFn","TypeError","call"],"mappings":"sLAiBAA,QAEA,yDAKA,OACA,iBAGA,UACA,mBACA,gFASAC,4CAIAC,SAAAC,OAAAC,OAAAC,EAAA,EAAAD,EAEA,SACA,QAEA,cAAAA,OAAAC,EAAA,EAAAD,EAGA,sDAIA,iBAEAE,mCAKA,IAAAC,EAAAC,wBAGAC,mCAEA,sDAGAC,iCAEA,uBAKAC,yDAKAC,cACA,+CAKAC,gBACA,sDAKAC,gDAIA,OACAN,sGAGAO,gFAGAC,8BAEA,yCAIAC,gEAGAC,0RAQA,gBAIA,oFAMA,4DAMAC,gCAIA,YACAC,gDAKAC,GAjBAC,GAAA,oEAmBA,IAAAC,EAAAC,EAAAC,YACAF,yBAEAJ,6GAMA,IAAAO,EAAAlB,6FACA,IAAAe,EAAAI,EAAAF,YACAG,cAGAC,+CAGAC,aACA,2GAIA,IAAAC,EAAAvB,sBACA,6DACA,kBAEA,YACA,sBAEA,6BAEA,gBACA,QACA,iCAEAwB,cAEA,sBAEA,mBAEAC,wBACA,eAEA,SACA,kBAEA,YACA,oBAEA,2CCrMAC,GADiBC,OAFjB,WAA0B,IAAAC,EAAA5B,KAAa6B,EAAAD,EAAAE,eAA0BC,EAAAH,EAAAI,MAAAD,IAAAF,EAAwB,OAAAE,EAAA,OAAiBE,YAAA,mBAA6BF,EAAA,YAAiBG,OAAOC,OAAAP,EAAAQ,SAAAC,gBAAA,aAAiDN,EAAA,WAAgBG,OAAOI,MAAA,WAAAC,YAAA,QAAAX,EAAAY,OAAA,OAA+DZ,EAAAa,GAAA,KAAAV,EAAA,WAA4BG,OAAOI,MAAA,WAAAC,YAAA,QAAAX,EAAAjB,SAAA,OAAiEiB,EAAAa,GAAA,KAAAV,EAAA,WAA4BG,OAAOI,MAAA,WAAAC,YAAA,QAAAX,EAAAN,SAAA,OAAiEM,EAAAa,GAAA,KAAAV,EAAA,WAA4BG,OAAOI,MAAA,OAAAV,EAAAc,KAAA,MAAAC,OAAAf,EAAAc,KAAAC,OAAAJ,YAAAX,EAAAc,KAAAH,gBAAiG,GAAAX,EAAAa,GAAA,KAAAb,EAAAgB,KAAA,KAAAb,EAAA,OAA4Cc,MAAAjB,EAAAkB,YAAoBf,EAAA,OAAYE,YAAA,cAAwBL,EAAAa,GAAAb,EAAAmB,GAAAnB,EAAAgB,KAAAI,SAAApB,EAAAa,GAAA,KAAAV,EAAA,OAAwDE,YAAA,gBAAwBL,EAAAqB,MAAA,IAErxBC,oBCCjB,IAcAC,EAdAC,EAAA,OAcAC,CACA7D,EACAkC,GATA,EAVA,SAAA4B,GACAF,EAAA,SAaA,kBAEA,MAUAG,EAAA,QAAAJ,EAAA,8BC1BAK,EAAAC,SAAkBC,QAAAN,EAAA,QAAAO,YAAA,8CCAlBP,EAAA,QACAA,EAAA,QACAI,EAAAC,QAAAL,EAAA,8BCFA,IAAAQ,EAAAR,EAAA,QACAS,EAAAT,EAAA,QACAI,EAAAC,QAAAL,EAAA,QAAAU,YAAA,SAAAC,GACA,IAAAC,EAAAH,EAAAE,GACA,sBAAAC,EAAA,MAAAC,UAAAF,EAAA,qBACA,OAAAH,EAAAI,EAAAE,KAAAH","file":"static/js/1.add8615409fd2e50746e.js","sourcesContent":["<!-- onload -->\r\n<template>\r\n  <div class=\"load-container\">\r\n    <el-steps :active=\"isActive\" finish-status=\"success\">\r\n      <el-step title=\"数据获取中...\" :description=\"`共计获取 ${getNum}条`\"></el-step>\r\n      <el-step title=\"存储数据中...\" :description=\"`共计插入 ${storeNum}条`\"></el-step>\r\n      <el-step title=\"缓存头像中...\" :description=\"`共计缓存 ${catchImg}张`\"></el-step>\r\n      <el-step :title=\"`数据校验${step.title}`\" :status=\"step.status\" :description=\"step.description\"></el-step>\r\n    </el-steps>\r\n    <div v-if=\"stop.show\" :class=\"classStop\">\r\n      <div class=\"stop-tips\">{{stop.tips}}</div>\r\n      <div class=\"stop-mask\"></div>\r\n    </div>\r\n  </div>\r\n</template>\r\n\r\n<script>\r\nimport { mapState, mapGetters } from 'vuex'\r\nexport default {\r\n  name: 'onload',\r\n  data () {\r\n    return {\r\n      request: null, // indexDB对象\r\n      stop: {\r\n        show: false,\r\n        tips: '叁'\r\n      }, // 倒计时文字--叁贰壹\r\n      step: {\r\n        title: '',\r\n        status: 'wait',\r\n        description: '校验数据是否一致'\r\n      }, // 最后一步提示语\r\n      getNum: 0, // 用户数据长度\r\n      storeNum: 0, // 存储数据长度\r\n      catchImg: 0, // 已缓存图片数量\r\n      isActive: 0 // 步骤流程\r\n    }\r\n  },\r\n  created () {\r\n    this.ready()\r\n  },\r\n  mounted () {},\r\n  components: {},\r\n  computed: {\r\n    ...mapState([\r\n      'DBname',\r\n      'DBver',\r\n      'storeName'\r\n    ]),\r\n    ...mapGetters([\r\n      'data'\r\n    ]),\r\n    // 利用计算属性绑定class\r\n    classStop () {\r\n      return {\r\n        'lottery-stop': true,\r\n        'show': this.stop.show\r\n      }\r\n    }\r\n  },\r\n  methods: {\r\n    // 1.初始化\r\n    ready () {\r\n      // 1.0.先删除本地indexDB数据表\r\n      this.deleteDB(this.DBname)\r\n\r\n      // 1.1.注意这里采用promise链式语法\r\n      this.$store.dispatch({type: 'getDatas'})\r\n        // 1.1.1获取数据\r\n        .then(() => {\r\n          this.getNum = this.data.userData.length\r\n          if (this.getNum !== 0) {\r\n            this.isActive = 1\r\n          }\r\n        })\r\n        // 1.1.2.初始化创建本地indexDB数据表\r\n        .then(() => {\r\n          this.initDatabase()\r\n        })\r\n        // 1.1.3.缓存头像\r\n        .then(() => {\r\n          setTimeout(() => {\r\n            this.preLoadImg()\r\n          }, 800)\r\n        })\r\n        // 1.1.4.校验数据--注意这里延时3s后执行\r\n        .then(() => {\r\n          setTimeout(() => {\r\n            this.validateData()\r\n          }, 5000)\r\n        })\r\n    },\r\n    // 2.删除本地表\r\n    deleteDB (name) {\r\n      indexedDB.deleteDatabase(name)\r\n    },\r\n    // 3.初始化表\r\n    initDatabase () {\r\n      if (window.indexedDB) {\r\n        const self = this\r\n        self.request = window.indexedDB.open(self.DBname, self.DBver) // 参数为：数据库名和版本号；数据库存在，则打开它；否则创建。\r\n        self.request.onsuccess = function (event) {\r\n          const mydb = event.target.result\r\n          // 插入用户数据表\r\n          self.insert(mydb, self.storeName.user, self.data.userData).then((res) => {\r\n            self.storeNum = res\r\n            if (self.storeNum !== 0) {\r\n              self.isActive = 2\r\n            }\r\n          })\r\n          // 插入奖项数据表\r\n          self.insert(mydb, self.storeName.award, self.data.type)\r\n        }\r\n        self.request.onerror = function (event) {\r\n          alert(`打开失败,错误号：${event.target.errorCode}`)\r\n        }\r\n        self.request.onupgradeneeded = function (event) {\r\n          const mydb = event.target.result // 获得数据库实例对象\r\n          if (!mydb.objectStoreNames.contains(self.storeName.user)) { // 判断对象存储空间名称是否已经存在\r\n            mydb.createObjectStore(self.storeName.user, {keyPath: 'CompleteID'}) // 创建storeName对象存储空间;指定keyPath选项为id（即主键为id）\r\n          }\r\n          if (!mydb.objectStoreNames.contains(self.storeName.award)) { // 判断对象存储空间名称是否已经存在\r\n            mydb.createObjectStore(self.storeName.award, {autoIncrement: true})\r\n          }\r\n        }\r\n      } else {\r\n        alert('您的浏览器不支持IndexedDB数据库。')\r\n      }\r\n    },\r\n    // 4.插入数据表，修改为Promise链式语法\r\n    insert (db, storeName, tempData) {\r\n      return new Promise((resolve, reject) => {\r\n        let storeNum = 0\r\n        // 使用事务\r\n        const transaction = db.transaction(storeName, // 事务操作的对象存储空间名\r\n          'readwrite') // 事务模式:'readwrite'可读写模式;READ_ONLY只读模式;VERSION_CHANGE版本升级模式;\r\n        // 2.1、当事务中的所有操作请求都被处理完成时触发\r\n        transaction.oncomplete = function (event) {\r\n          resolve(storeNum)\r\n        }\r\n        // 2.2、当事务中出现错误时触发，默认的处理方式为回滚事务；\r\n        transaction.onerror = function (event) {\r\n          alert('数据插入失败')\r\n          reject(event)\r\n        }\r\n        // 2.3、当事务被终止时触发\r\n        transaction.onabort = function (event) { }\r\n        // 2.4、从事务中获得相关的对象存储空间对象\r\n        const objStore = transaction.objectStore(storeName)\r\n        // 2.5、向storeName存储空间加入一个storeName对象，获得request对象用于处理用户对数据库的操作请求(同样拥有onerror，onupgradeneeded，onsuccess事件)\r\n        for (const item of tempData) {\r\n          const request = objStore.add(item)\r\n          request.onsuccess = function (e) {\r\n            storeNum++\r\n          }\r\n        }\r\n      })\r\n    },\r\n    // 5.缓存图片\r\n    preLoadImg () {\r\n      for (const item of this.data.userData) {\r\n        const tempImg = new Image()\r\n        // 图片src地址\r\n        // tempImg.src = 'http://www.jaja365.cn' + item.HeadImg\r\n        tempImg.src = item.HeadImg\r\n        // 图片加载完成\r\n        tempImg.addEventListener('load', () => {\r\n          this.catchImg++\r\n        }, false)\r\n      }\r\n    },\r\n    // 6.数据校验\r\n    validateData () {\r\n      this.isActive = 3\r\n      if (this.catchImg === this.getNum && this.catchImg === this.storeNum) {\r\n        const corStep = {\r\n          title: '成功',\r\n          status: 'success',\r\n          description: '3秒后进入抽奖页面'\r\n        }\r\n        this.step = corStep\r\n        this.stop.show = true\r\n        this.isActive = 4\r\n        let endTime = 3\r\n        const stopTimer = setInterval(() => {\r\n          endTime--\r\n          if (endTime === 2) {\r\n            this.stop.tips = '贰'\r\n          } else if (endTime === 1) {\r\n            this.stop.tips = '壹'\r\n          } else {\r\n            clearInterval(stopTimer)\r\n            this.$router.push({ path: '/lottery' })\r\n          }\r\n        }, 1000)\r\n      } else {\r\n        const errStep = {\r\n          title: '失败',\r\n          status: 'error',\r\n          description: '请重新进入或者 强制刷新本页面'\r\n        }\r\n        this.step = errStep\r\n      }\r\n    }\r\n  },\r\n  watch: {},\r\n  filters: {}\r\n}\r\n</script>\r\n\r\n<style lang='less' scoped>\r\n.load-container{\r\n  padding: 50px;\r\n  font-size: 20px;\r\n  .lottery-stop{\r\n    display: none;\r\n    position: fixed;\r\n    top: 0;\r\n    left: 0;\r\n    width: 100%;\r\n    height: 100%;\r\n    z-index: 9;\r\n    transition: all 0.3s;\r\n    &.show{\r\n      display: block;\r\n    }\r\n    .stop-tips{\r\n      position: absolute;\r\n      left: 50%;\r\n      top: 50%;\r\n      transform: translate3d(-50%, -50%, 0);\r\n      text-align: center;\r\n      font-size: 18rem;\r\n      padding: 0 3rem;\r\n      color: #FD361F;\r\n      font-family: 'STKaiti', 'KaiTi ';\r\n      border: 4px solid #FD361F;\r\n      border-radius: 100%;\r\n    }\r\n    .stop-mask{\r\n      position: absolute;\r\n      width: 100%;\r\n      height: 100%;\r\n      background: rgba(0,0,0,0.1);\r\n    }\r\n  }\r\n}\r\n</style>\r\n\n\n\n// WEBPACK FOOTER //\n// src/views/onload.vue","var render = function () {var _vm=this;var _h=_vm.$createElement;var _c=_vm._self._c||_h;return _c('div',{staticClass:\"load-container\"},[_c('el-steps',{attrs:{\"active\":_vm.isActive,\"finish-status\":\"success\"}},[_c('el-step',{attrs:{\"title\":\"数据获取中...\",\"description\":(\"共计获取 \" + _vm.getNum + \"条\")}}),_vm._v(\" \"),_c('el-step',{attrs:{\"title\":\"存储数据中...\",\"description\":(\"共计插入 \" + _vm.storeNum + \"条\")}}),_vm._v(\" \"),_c('el-step',{attrs:{\"title\":\"缓存头像中...\",\"description\":(\"共计缓存 \" + _vm.catchImg + \"张\")}}),_vm._v(\" \"),_c('el-step',{attrs:{\"title\":(\"数据校验\" + (_vm.step.title)),\"status\":_vm.step.status,\"description\":_vm.step.description}})],1),_vm._v(\" \"),(_vm.stop.show)?_c('div',{class:_vm.classStop},[_c('div',{staticClass:\"stop-tips\"},[_vm._v(_vm._s(_vm.stop.tips))]),_vm._v(\" \"),_c('div',{staticClass:\"stop-mask\"})]):_vm._e()],1)}\nvar staticRenderFns = []\nvar esExports = { render: render, staticRenderFns: staticRenderFns }\nexport default esExports\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./node_modules/vue-loader/lib/template-compiler?{\"id\":\"data-v-32ffd84b\",\"hasScoped\":true,\"transformToRequire\":{\"video\":[\"src\",\"poster\"],\"source\":\"src\",\"img\":\"src\",\"image\":\"xlink:href\"},\"buble\":{\"transforms\":{}}}!./node_modules/vue-loader/lib/selector.js?type=template&index=0!./src/views/onload.vue\n// module id = null\n// module chunks = ","function injectStyle (ssrContext) {\n  require(\"!!../../node_modules/extract-text-webpack-plugin/dist/loader.js?{\\\"omit\\\":1,\\\"remove\\\":true,\\\"publicPath\\\":\\\"../../\\\"}!vue-style-loader!css-loader?{\\\"sourceMap\\\":true}!../../node_modules/vue-loader/lib/style-compiler/index?{\\\"vue\\\":true,\\\"id\\\":\\\"data-v-32ffd84b\\\",\\\"scoped\\\":true,\\\"hasInlineConfig\\\":false}!less-loader?{\\\"sourceMap\\\":true}!../../node_modules/vue-loader/lib/selector?type=styles&index=0!./onload.vue\")\n}\nvar normalizeComponent = require(\"!../../node_modules/vue-loader/lib/component-normalizer\")\n/* script */\nexport * from \"!!babel-loader!../../node_modules/vue-loader/lib/selector?type=script&index=0!./onload.vue\"\nimport __vue_script__ from \"!!babel-loader!../../node_modules/vue-loader/lib/selector?type=script&index=0!./onload.vue\"\n/* template */\nimport __vue_template__ from \"!!../../node_modules/vue-loader/lib/template-compiler/index?{\\\"id\\\":\\\"data-v-32ffd84b\\\",\\\"hasScoped\\\":true,\\\"transformToRequire\\\":{\\\"video\\\":[\\\"src\\\",\\\"poster\\\"],\\\"source\\\":\\\"src\\\",\\\"img\\\":\\\"src\\\",\\\"image\\\":\\\"xlink:href\\\"},\\\"buble\\\":{\\\"transforms\\\":{}}}!../../node_modules/vue-loader/lib/selector?type=template&index=0!./onload.vue\"\n/* template functional */\nvar __vue_template_functional__ = false\n/* styles */\nvar __vue_styles__ = injectStyle\n/* scopeId */\nvar __vue_scopeId__ = \"data-v-32ffd84b\"\n/* moduleIdentifier (server only) */\nvar __vue_module_identifier__ = null\nvar Component = normalizeComponent(\n  __vue_script__,\n  __vue_template__,\n  __vue_template_functional__,\n  __vue_styles__,\n  __vue_scopeId__,\n  __vue_module_identifier__\n)\n\nexport default Component.exports\n\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./src/views/onload.vue\n// module id = null\n// module chunks = ","module.exports = { \"default\": require(\"core-js/library/fn/get-iterator\"), __esModule: true };\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./node_modules/babel-runtime/core-js/get-iterator.js\n// module id = BO1k\n// module chunks = 1","require('../modules/web.dom.iterable');\nrequire('../modules/es6.string.iterator');\nmodule.exports = require('../modules/core.get-iterator');\n\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./node_modules/core-js/library/fn/get-iterator.js\n// module id = fxRn\n// module chunks = 1","var anObject = require('./_an-object');\nvar get = require('./core.get-iterator-method');\nmodule.exports = require('./_core').getIterator = function (it) {\n  var iterFn = get(it);\n  if (typeof iterFn != 'function') throw TypeError(it + ' is not iterable!');\n  return anObject(iterFn.call(it));\n};\n\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./node_modules/core-js/library/modules/core.get-iterator.js\n// module id = g8Ux\n// module chunks = 1"],"sourceRoot":""}